## 第三章

### 名词解释

- **流水线**：将一个重复的时序过程，分解成为若干个子过程，而每一个子过程都可有效地在其专用功能段上与其它子过程同时执行

- **数据相关**：考虑两条指令i和j，*i*在*j*的前面，如果下述条件之一成立，则称指令*j*与指令i数据相关： 

  （1）指令*j*使用指令*i*产生的结果；

  （2）指令*j*与指令*k*数据相关，而指令*k*又与指令*i*数据相关。

- **名相关**：如果两条指令使用了相同的名，但是它们之间并没有数据流动，则称这两条指令存在名相关。

- **反相关**：考虑两条指令*i*和*j*，*i*在*j*的前面，如果指令*j*所写的名与指令*i*所读的名相同，则称指令*i*和*j*发生了反相关。

- **输出相关**：考虑两条指令*i*和*j*，*i*在*j*的前面，如果指令*j*和指令*i*所写的名相同，则称指令*i*和*j*发生了输出相关。

- **结构冲突**：因硬件资源满足不了指令重叠执行的要求而发生的冲突。

- **数据冲突**：当指令在流水线中重叠执行时，因需要用到前面指令的执行结果而发生的冲突。

- **控制冲突**：流水线遇到分支指令或其它会改变PC值的指令所引起的冲突。

- **定向**：用来解决写后读冲突的。

- **写后读冲突**

  **写后写冲突**、**读后写冲突** （经典5段不会出现的）

- **链接技术**：具有先写后读相关的两条指令，在不出现功能部件冲突和Vi冲突的情况下，可以把功能部件链接起来进行流水处理，以达到加快执行的目的。

- **分段开采**：当向量的长度大于向量寄存器的长度时，必须把长向量分成长度固定的段，然后循环分段处理，每一次循环只处理一个向量段。

### 3.1 流水线基本概念

- 流水线技术

  - 流水线的**级**或**段**
  - 流水线的**深度**

- 流水线特点

  - 分解为多个子过程，专门的功能部件

  - 各段时间相等

    时间长的段成为流水线的**瓶颈**

  - 功能部件后面又一个缓冲寄存器（锁存器）-> **流水寄存器**

    **作用**：相邻两段之间<u>传送数据</u>，保证提供后面要用到的数据，各段的处理工作<u>相互隔离</u>

  - 大量的时序过程，才能发挥效率

  - **通过时间**和**排空时间**

    第一个和最后一个，从进入到流出所需要的时间

- 分类

  - 单功能、多功能（ASC）

  - 静态流水线、动态流水线

  - 部件级流水线（运算操作流水线）

    处理机级流水线（指令流水线）

    处理机间流水线（宏流水线）

  - 线性流水线、非线性流水线

    - 非线性 调度问题，争用流水段

  - 顺序流水线、乱序流水线（无序、错序、异步）

  - 标量处理机、向量处理机

### 3.2 性能指标

- **吞吐率TP** 

  单位时间完成的任务数量或输出结果的数量

  - 实际，最大

  解决**流水线瓶颈**的方法

  - **细分瓶颈段**
  - **重复设置瓶颈段**

- **加速比S**

  不使用流水线和使用流水线所用的时间比

  最大加速比 = k

  流水线的段数并非越多越好。

- **效率E**

  流水线中设备实际使用时间与整个运行时间的比值。（数面积）

问题：

- 瓶颈问题

- 额外开销

  - 流水寄存器延迟

    建立时间：信号到达前，寄存器保持稳定的时间

    传输延迟：信号到达后，寄存器输出可用的时间

  - 时钟偏移开销

    时钟到达各流水寄存器的最大差值时间

  时钟周期小到与额外开销相同时，流水已没有意义。

- 冲突问题—最重要的问题之一

### 3.3 相关与冲突

5段RICS：IF -> ID -> EX -> MEM -> WB

- **相关**

  两条指令之间在某种依赖关系

  - 数据相关

  - 名相关 （i写j读）

    相同的名，但没有数据流动

    - 反相关 （i读j写）
    - 输出相关（i写j写）

  - 控制相关

- **流水线冲突**

  - **结构冲突**

    原因：

    - 功能部件不是完全流水的
    - 资源份数不够

    访存冲突：

    1. 插入暂停周期（流水线气泡）

    2. 设置独立的指令、数据存储器

       或者独立的指令、数据Cache

    语序结构冲突的存在：成本

  - **数据冲突**

    靠太近

    - RAW 写后读

    - WAW 写后写

      只发生在：

      - 流水线不止一个段可以写
      - 当前停顿，后续可以前进

      5段里面不存在的

    - WAR 读后写

      只发生在：

      - 有的写提前、有的读滞后
      - 重新排序

      依然不存在的

    **定向技术**

    - 将计算结果从其**产生的地方**直接送到其他指令**需要它的地方**，那么就可以避免停顿

    - 然而，定向并不能解决所有问题，比如：LD->DADD

      增加**互锁硬件**，插入暂停

      作用：检测发现数据冲突，使流水线停顿

    **指令调度**／**流水线调度**

    让编译器重新组织顺序

  - **控制冲突**

    简单方法：冻结、排空（3个周期的延迟）

    **分支延迟**：由分支指令引起的

    假设：**判断转移成功**和**确定目标地址**都在**ID**段完成->分支延迟为一个周期

    3种编译器减少延迟的方法：（静态）

    - **预测分支失败**

      - 确定失败，不跳转，一切正常

      - 确定成功，跳转，之前的指令转化为空操作

        保重能够退回原先的状态

    - **预测分支成功**

      - 前提：先知道跳转的目标地址

        对5段流水线没有任何好处

    - **延迟分支**

      延迟分支指令的执行时间，加上**延迟槽**

      - 从前调度
      - 从目标出调度
      - 从失败处调度

      **分支取消机制**

### 3.4 实现--MIPS

- 流水寄存器

- 所有的数据冲突可以在ID段检测到，流出ID前暂停->互锁

  load互锁

  检测到RAW冲突，IF、ID段的指令不再前进：

  - ID/EX.IR中的操作吗改为0
  - IF/ID寄存器的内容回送到自己的入口

- ID段增设加法器

- 条件测试移到ID段

- 结果送回IF段的MUX1

  ​